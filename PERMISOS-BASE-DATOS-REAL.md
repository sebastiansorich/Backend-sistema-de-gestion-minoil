# üîê Sistema de Permisos con Base de Datos Real

Este documento describe c√≥mo el sistema de permisos ha sido conectado con la base de datos SAP HANA real, reemplazando los datos simulados.

## üìã Cambios Realizados

### 1. **Servicio de Permisos Actualizado** (`src/modules/permisos/permisos.service.ts`)

- ‚úÖ **Conectado con SAP HANA**: El servicio ahora usa `SapHanaService` para todas las operaciones
- ‚úÖ **Validaciones reales**: Verifica que roles y m√≥dulos existan en la base de datos
- ‚úÖ **Operaciones CRUD completas**: Crear, leer, actualizar y eliminar permisos reales
- ‚úÖ **Enriquecimiento de datos**: Incluye informaci√≥n de roles y m√≥dulos en las respuestas
- ‚úÖ **Manejo de errores**: Validaciones y mensajes de error apropiados

### 2. **Servicio SAP HANA Mejorado** (`src/modules/sap/sap-hana.service.ts`)

- ‚úÖ **M√©todos de permisos**: `obtenerPermisos()`, `obtenerPermisosPorRol()`, `obtenerPermisosPorModulo()`
- ‚úÖ **Operaciones CRUD**: `crearPermiso()`, `actualizarPermiso()`, `eliminarPermiso()`
- ‚úÖ **Validaciones**: Verificaci√≥n de existencia de roles y m√≥dulos
- ‚úÖ **Transacciones seguras**: Manejo de errores y rollback autom√°tico

### 3. **M√≥dulo de Permisos Actualizado** (`src/modules/permisos/permisos.module.ts`)

- ‚úÖ **Dependencias**: Importa `SapModule` para acceder a `SapHanaService`
- ‚úÖ **Inyecci√≥n de dependencias**: Configurado correctamente para NestJS

## üóÑÔ∏è Estructura de Base de Datos

### Tablas Requeridas

```sql
-- Tabla de roles
CREATE TABLE "MINOILDES"."roles" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "nombre" NVARCHAR(100) NOT NULL UNIQUE,
    "descripcion" NVARCHAR(500),
    "activo" BOOLEAN DEFAULT TRUE,
    "createdAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de m√≥dulos
CREATE TABLE "MINOILDES"."modulos" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "nombre" NVARCHAR(100) NOT NULL,
    "descripcion" NVARCHAR(500),
    "ruta" NVARCHAR(200) NOT NULL UNIQUE,
    "activo" BOOLEAN DEFAULT TRUE,
    "esMenu" BOOLEAN DEFAULT TRUE,
    "icono" NVARCHAR(50),
    "nivel" INTEGER DEFAULT 1,
    "orden" INTEGER DEFAULT 0,
    "padreId" INTEGER,
    "createdAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("padreId") REFERENCES "MINOILDES"."modulos"("id")
);

-- Tabla de permisos
CREATE TABLE "MINOILDES"."permisos" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "rolId" INTEGER NOT NULL,
    "moduloId" INTEGER NOT NULL,
    "crear" BOOLEAN DEFAULT FALSE,
    "leer" BOOLEAN DEFAULT FALSE,
    "actualizar" BOOLEAN DEFAULT FALSE,
    "eliminar" BOOLEAN DEFAULT FALSE,
    "createdAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("rolId") REFERENCES "MINOILDES"."roles"("id") ON DELETE CASCADE,
    FOREIGN KEY ("moduloId") REFERENCES "MINOILDES"."modulos"("id") ON DELETE CASCADE,
    UNIQUE ("rolId", "moduloId")
);
```

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. **Ejecutar Script de Base de Datos**

```bash
# Conectar a SAP HANA y ejecutar el script
psql -h tu-servidor-hana -U tu-usuario -d MINOILDES -f crear-tablas-permisos.sql
```

### 2. **Verificar Variables de Entorno**

```env
# .env
SAP_HANA_HOST=srvhana
SAP_HANA_PORT=30015
SAP_HANA_USERNAME=CONSULTA
SAP_HANA_PASSWORD=tu-password
SAP_HANA_DATABASE=MINOILDES
```

### 3. **Instalar Dependencias**

```bash
npm install
```

### 4. **Ejecutar el Servidor**

```bash
npm run start:dev
```

## üß™ Pruebas

### Ejecutar Script de Pruebas

```bash
# Instalar axios si no est√° instalado
npm install axios

# Ejecutar pruebas
node test-permisos.js
```

### Endpoints Disponibles

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/permisos` | Obtener todos los permisos |
| GET | `/permisos/rol/:rolId` | Obtener permisos por rol |
| GET | `/permisos/modulo/:moduloId` | Obtener permisos por m√≥dulo |
| GET | `/permisos/:id` | Obtener permiso espec√≠fico |
| POST | `/permisos` | Crear nuevo permiso |
| PATCH | `/permisos/:id` | Actualizar permiso |
| DELETE | `/permisos/:id` | Eliminar permiso |

### Ejemplo de Crear Permiso

```json
POST /permisos
{
  "rolId": 1,
  "moduloId": 2,
  "crear": true,
  "leer": true,
  "actualizar": false,
  "eliminar": false
}
```

## üîß Funcionalidades Implementadas

### ‚úÖ **Validaciones**
- Verificaci√≥n de existencia de roles
- Verificaci√≥n de existencia de m√≥dulos
- Prevenci√≥n de permisos duplicados
- Validaci√≥n de datos de entrada

### ‚úÖ **Operaciones CRUD**
- **Crear**: Nuevos permisos con validaciones
- **Leer**: Lista completa, por rol, por m√≥dulo, espec√≠fico
- **Actualizar**: Modificaci√≥n de permisos existentes
- **Eliminar**: Eliminaci√≥n segura con validaciones

### ‚úÖ **Enriquecimiento de Datos**
- Informaci√≥n completa del rol asociado
- Informaci√≥n completa del m√≥dulo asociado
- Conteos y estad√≠sticas
- Respuestas estructuradas

### ‚úÖ **Manejo de Errores**
- Errores espec√≠ficos para cada caso
- Mensajes descriptivos
- C√≥digos de estado HTTP apropiados
- Logging detallado

## üìä Estructura de Respuesta

### Respuesta Exitosa
```json
{
  "success": true,
  "data": {
    "id": 1,
    "rolId": 1,
    "moduloId": 2,
    "crear": true,
    "leer": true,
    "actualizar": false,
    "eliminar": false,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z",
    "rol": {
      "id": 1,
      "nombre": "Administrador",
      "descripcion": "Rol con todos los permisos"
    },
    "modulo": {
      "id": 2,
      "nombre": "Usuarios",
      "ruta": "/usuarios"
    }
  },
  "total": 1,
  "message": "Permiso creado exitosamente"
}
```

### Respuesta de Error
```json
{
  "success": false,
  "error": "Ya existe un permiso para este rol y m√≥dulo",
  "message": "Error creando permiso"
}
```

## üîç Diagn√≥stico y Troubleshooting

### Verificar Conexi√≥n a Base de Datos

```bash
# Endpoint de diagn√≥stico
GET /sap/diagnostico

# Probar consulta de roles
GET /sap/test-roles

# Verificar tablas
GET /sap/list-tables
```

### Errores Comunes

1. **Error de conexi√≥n a HANA**
   - Verificar variables de entorno
   - Verificar credenciales
   - Verificar red y firewall

2. **Tablas no encontradas**
   - Ejecutar script `crear-tablas-permisos.sql`
   - Verificar schema `MINOILDES`
   - Verificar permisos de usuario

3. **Errores de validaci√≥n**
   - Verificar que roles y m√≥dulos existan
   - Verificar formato de datos
   - Revisar logs del servidor

## üìà Pr√≥ximos Pasos

### Mejoras Sugeridas

1. **Cache de Permisos**
   - Implementar Redis para cache
   - Optimizar consultas frecuentes

2. **Auditor√≠a**
   - Log de cambios en permisos
   - Historial de modificaciones

3. **Permisos Granulares**
   - Permisos por acci√≥n espec√≠fica
   - Permisos condicionales

4. **Interfaz de Usuario**
   - Panel de administraci√≥n de permisos
   - Gesti√≥n visual de roles y m√≥dulos

## üéØ Conclusi√≥n

El sistema de permisos ahora est√° completamente conectado con la base de datos SAP HANA real, proporcionando:

- ‚úÖ **Datos reales**: No m√°s datos simulados
- ‚úÖ **Validaciones robustas**: Verificaci√≥n de integridad
- ‚úÖ **Operaciones completas**: CRUD completo
- ‚úÖ **Escalabilidad**: Preparado para crecimiento
- ‚úÖ **Mantenibilidad**: C√≥digo limpio y documentado

El sistema est√° listo para producci√≥n y puede manejar la gesti√≥n completa de permisos en un entorno empresarial real.
